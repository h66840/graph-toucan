from typing import Dict, Any, Optional

def call_external_api(tool_name: str) -> Dict[str, Any]:
    """
    Simulates fetching data from external API for penetration testing reasoning.

    Returns:
        Dict with simple fields only (str, int, float, bool):
        - attackStepNumber (int): current step number in the attack chain
        - totalAttackSteps (int): total expected number of steps in the full attack chain
        - nextAttackStepNeeded (bool): indicates whether additional attack steps should be generated
        - attackStep (str): description of the current attack step or action
        - nodeId (str): identifier for the current node in the reasoning tree
        - score (float): heuristic score representing the quality or likelihood of success
        - strategyUsed (str): the strategy employed to generate this step
        - stats_totalNodes (int): total number of nodes explored
        - stats_averageScore (float): average score across all nodes
        - stats_maxDepth (int): maximum depth reached in the search tree
        - stats_branchingFactor (float): average branching factor
        - stats_strategyMetrics_iterations (int): number of iterations performed
        - stats_strategyMetrics_rollouts (int): number of rollouts (for MCTS)
        - stats_strategyMetrics_beamWidth (int): beam width used (for beam search)
    """
    return {
        "attackStepNumber": 3,
        "totalAttackSteps": 5,
        "nextAttackStepNeeded": True,
        "attackStep": "Exploit SQL injection vulnerability to extract user credentials",
        "nodeId": "node_3a",
        "score": 0.87,
        "strategyUsed": "beam_search",
        "stats_totalNodes": 150,
        "stats_averageScore": 0.72,
        "stats_maxDepth": 5,
        "stats_branchingFactor": 3.2,
        "stats_strategyMetrics_iterations": 1000,
        "stats_strategyMetrics_rollouts": 500,
        "stats_strategyMetrics_beamWidth": 10
    }

def pentestthinking_pentestthinkingMCP(
    attackStep: str,
    attackStepNumber: int,
    nextAttackStepNeeded: bool,
    strategyType: Optional[str] = None,
    totalAttackSteps: int = 1
) -> Dict[str, Any]:
    """
    Advanced reasoning tool for penetration testing that generates the next attack step
    using multiple strategies such as Beam Search and Monte Carlo Tree Search.

    Args:
        attackStep (str): Current attack step or action in the penetration test
        attackStepNumber (int): Current step number in the attack chain
        nextAttackStepNeeded (bool): Whether another attack step is needed
        strategyType (str, optional): Attack strategy to use ('beam_search' or 'mcts'). Defaults to 'beam_search'.
        totalAttackSteps (int): Total expected steps in the attack chain

    Returns:
        Dict containing:
            - attackStepNumber (int): current step number
            - totalAttackSteps (int): total expected steps
            - nextAttackStepNeeded (bool): whether more steps are needed
            - attackStep (str): description of current attack step
            - nodeId (str): identifier for current node in reasoning tree
            - score (float): heuristic score for step quality
            - strategyUsed (str): strategy employed ('beam_search' or 'mcts')
            - stats (Dict): execution metrics including totalNodes, averageScore,
              maxDepth, branchingFactor, and strategy-specific metrics
    """
    # Input validation
    if attackStepNumber < 1:
        raise ValueError("attackStepNumber must be a positive integer")
    if totalAttackSteps < 1:
        raise ValueError("totalAttackSteps must be a positive integer")
    if attackStepNumber > totalAttackSteps:
        raise ValueError("attackStepNumber cannot exceed totalAttackSteps")
    if strategyType not in [None, "beam_search", "mcts"]:
        raise ValueError("strategyType must be 'beam_search', 'mcts', or None")

    # Default to beam_search if strategy not specified
    effective_strategy = strategyType or "beam_search"

    # Simulate computation based on inputs
    progress_ratio = attackStepNumber / totalAttackSteps
    base_score = 0.9 - (progress_ratio * 0.3)  # Slight decay in confidence as steps progress

    # Call simulated external API to get generated step data
    api_data = call_external_api("pentestthinking-pentestthinkingMCP")

    # Construct the stats dictionary from flattened API response
    stats = {
        "totalNodes": api_data["stats_totalNodes"],
        "averageScore": api_data["stats_averageScore"],
        "maxDepth": api_data["stats_maxDepth"],
        "branchingFactor": api_data["stats_branchingFactor"],
        "strategyMetrics": {
            "iterations": api_data["stats_strategyMetrics_iterations"],
            "rollouts": api_data["stats_strategyMetrics_rollouts"],
            "beamWidth": api_data["stats_strategyMetrics_beamWidth"]
        }
    }

    # Construct final result matching output schema
    result = {
        "attackStepNumber": api_data["attackStepNumber"],
        "totalAttackSteps": api_data["totalAttackSteps"],
        "nextAttackStepNeeded": api_data["nextAttackStepNeeded"],
        "attackStep": api_data["attackStep"],
        "nodeId": api_data["nodeId"],
        "score": api_data["score"],
        "strategyUsed": api_data["strategyUsed"],
        "stats": stats
    }

    return result