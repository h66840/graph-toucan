# backward_to_query.py ä½¿ç”¨è¯´æ˜

## åŠŸèƒ½æ¦‚è¿°

`generate_queries_for_all_turns` å‡½æ•°ç”¨äºä¸ºæ‰€æœ‰ random walk paths ç”Ÿæˆ atomic queries å’Œæœ€ç»ˆ merged queriesã€‚

## æ–°å¢ç‰¹æ€§

### 1. æ–­ç‚¹ç»­ä¼ ï¼ˆResumeï¼‰

å½“æœåŠ¡å™¨å´©æºƒæˆ–ä¸­æ–­æ—¶ï¼Œå¯ä»¥ä»ä¸Šæ¬¡åœæ­¢çš„åœ°æ–¹ç»§ç»­å¤„ç†ï¼Œé¿å…é‡å¤è®¡ç®—ã€‚

**å·¥ä½œåŸç†ï¼š**
- è¯»å–è¾“å‡ºæ–‡ä»¶ä¸­å·²å¤„ç†æˆåŠŸçš„ pathsï¼ˆé€šè¿‡ `start_index` å’Œ `walk_id` è¯†åˆ«ï¼‰
- è‡ªåŠ¨è·³è¿‡å·²æˆåŠŸçš„ paths
- **å¤±è´¥çš„ paths ä¸ä¼šè¢«å†™å…¥æ–‡ä»¶**ï¼Œä¸‹æ¬¡è¿è¡Œæ—¶ä¼šè‡ªåŠ¨é‡æ–°å¤„ç†
- ä»¥è¿½åŠ æ¨¡å¼ç»§ç»­å†™å…¥æ–°å¤„ç†çš„æˆåŠŸç»“æœ

**é‡è¦ç‰¹æ€§ï¼š**
- âœ… æˆåŠŸçš„è®°å½•ä¼šè¢«ä¿ç•™å’Œè·³è¿‡
- âŒ å¤±è´¥çš„è®°å½•**ä¸ä¼šå†™å…¥æ–‡ä»¶**ï¼ˆåªæ‰“å°é”™è¯¯æ—¥å¿—ï¼‰
- ğŸ”„ å¤±è´¥çš„ paths ä¸‹æ¬¡ `--resume` æ—¶ä¼šè‡ªåŠ¨é‡è¯•ï¼ˆå› ä¸ºä¸åœ¨æˆåŠŸè®°å½•ä¸­ï¼‰
- ğŸ“ è¾“å‡ºæ–‡ä»¶åªåŒ…å«æˆåŠŸçš„è®°å½•
- ğŸ“Œ è¿½åŠ æ¨¡å¼ï¼šåŸæœ‰è®°å½•ä¸ä¼šè¢«è¦†ç›–ï¼Œæ›´å®‰å…¨

### 2. æ—©åœæœºåˆ¶ï¼ˆEarly Stopï¼‰

å½“è¿ç»­å¤šä¸ª batch å…¨éƒ¨å¤±è´¥æ—¶ï¼Œè‡ªåŠ¨åœæ­¢å¤„ç†ï¼Œé¿å…æµªè´¹è®¡ç®—èµ„æºã€‚

**å·¥ä½œåŸç†ï¼š**
- ç»Ÿè®¡æ¯ä¸ª batch çš„å¤±è´¥æ•°é‡
- å¦‚æœæŸä¸ª batch å…¨éƒ¨å¤±è´¥ï¼Œå¢åŠ è¿ç»­å¤±è´¥è®¡æ•°
- å½“è¿ç»­å¤±è´¥çš„ batch æ•°è¾¾åˆ°é˜ˆå€¼æ—¶ï¼Œè§¦å‘æ—©åœ
- å¦‚æœæŸä¸ª batch æœ‰æˆåŠŸçš„ï¼Œé‡ç½®è¿ç»­å¤±è´¥è®¡æ•°

## å‘½ä»¤è¡Œå‚æ•°

```bash
python src/backward_to_query.py [OPTIONS]
```

### å‚æ•°è¯´æ˜

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `--max-paths` | int | None | æœ€å¤šå¤„ç†å¤šå°‘ä¸ª pathsï¼ˆç”¨äºæµ‹è¯•ï¼‰ |
| `--batch-size` | int | 10 | å¹¶å‘æ‰¹æ¬¡å¤§å° |
| `--resume` | flag | False | å¯ç”¨æ–­ç‚¹ç»­ä¼  |
| `--early-stop` | int | 3 | è¿ç»­å¤šå°‘ä¸ª batch å…¨éƒ¨å¤±è´¥ååœæ­¢ï¼ˆ0 è¡¨ç¤ºç¦ç”¨ï¼‰ |
| `--test` | flag | False | æµ‹è¯•æ¨¡å¼ï¼šåªå¤„ç† 5 ä¸ª paths |

## ä½¿ç”¨ç¤ºä¾‹

### 1. æ­£å¸¸è¿è¡Œï¼ˆå¤„ç†æ‰€æœ‰ pathsï¼‰

```bash
python src/backward_to_query.py
```

### 2. æµ‹è¯•æ¨¡å¼ï¼ˆåªå¤„ç† 5 ä¸ª pathsï¼‰

```bash
python src/backward_to_query.py --test
```

### 3. è‡ªå®šä¹‰ batch size

```bash
python src/backward_to_query.py --batch-size 20
```

### 4. å¯ç”¨æ–­ç‚¹ç»­ä¼ ï¼ˆä»ä¸Šæ¬¡ä¸­æ–­å¤„ç»§ç»­ï¼‰

```bash
python src/backward_to_query.py --resume
```

**ç¤ºä¾‹è¾“å‡ºï¼š**
```
ğŸ”„ Resume mode enabled, reading existing results from fsp_path/fsp_v1.json...
   Found 150 already processed paths
   Skipping 150 already processed paths
   Remaining 350 paths to process
```

### 5. è°ƒæ•´æ—©åœé˜ˆå€¼

```bash
# è¿ç»­ 5 ä¸ª batch å…¨éƒ¨å¤±è´¥ååœæ­¢
python src/backward_to_query.py --early-stop 5

# ç¦ç”¨æ—©åœ
python src/backward_to_query.py --early-stop 0
```

### 6. ç»„åˆä½¿ç”¨

```bash
# æ–­ç‚¹ç»­ä¼  + è‡ªå®šä¹‰ batch size + è°ƒæ•´æ—©åœé˜ˆå€¼
python src/backward_to_query.py --resume --batch-size 15 --early-stop 5
```

## è¾“å‡ºæ–‡ä»¶

**è·¯å¾„ï¼š** `fsp_path/fsp_v1.json`

**æ ¼å¼ï¼š** æ¯è¡Œä¸€ä¸ª JSON å¯¹è±¡ï¼ˆJSONL æ ¼å¼ï¼‰

**è®°å½•ç»“æ„ï¼š**

```json
{
  "path_info": {
    "start_index": 123,
    "start_name": "function_name",
    "walk_id": "walk_456"
  },
  "atomic_queries": ["query1", "query2", ...],
  "fc_results": [...],
  "tool_outputs": [...],
  "token_usage": {
    "prompt_tokens": 1000,
    "completion_tokens": 500,
    "total_tokens": 1500
  },
  ...
}
```

**é”™è¯¯è®°å½•ï¼š**

```json
{
  "path_info": {
    "start_index": 789,
    "start_name": "function_name",
    "walk_id": "walk_101"
  },
  "error": "Error message here"
}
```

## è¿›åº¦æ˜¾ç¤º

å¤„ç†è¿‡ç¨‹ä¸­ä¼šæ˜¾ç¤ºè¯¦ç»†çš„è¿›åº¦ä¿¡æ¯ï¼š

```
[Batch 5/100] Processing paths 21-25 out of 500...
[Batch 5] time=12.34s, batch_tokens=15000, overall_tokens=75000, batch_errors=0/5
```

**æ—©åœè§¦å‘ç¤ºä¾‹ï¼š**

```
[Batch 8] âŒ ALL 5 paths FAILED! (consecutive failed batches: 3/3)

================================================================================
ğŸ›‘ EARLY STOPPING TRIGGERED
================================================================================
Consecutive failed batches: 3
Stopping to prevent further failures...
================================================================================
```

## æ–­ç‚¹ç»­ä¼ å·¥ä½œæµç¨‹

1. **é¦–æ¬¡è¿è¡Œï¼š**
   ```bash
   python src/backward_to_query.py --batch-size 10
   ```
   - å¤„ç† 200 ä¸ª paths
   - æˆåŠŸ 150 ä¸ª âœ…
   - å¤±è´¥ 50 ä¸ª âŒï¼ˆä¸å†™å…¥æ–‡ä»¶ï¼Œåªæ‰“å°é”™è¯¯ï¼‰
   - æœåŠ¡å™¨å´©æºƒ ğŸ’¥

2. **æ¢å¤è¿è¡Œï¼š**
   ```bash
   python src/backward_to_query.py --resume --batch-size 10
   ```
   - è¯»å–æ–‡ä»¶ï¼Œå‘ç° 150 ä¸ªæˆåŠŸè®°å½•
   - è·³è¿‡è¿™ 150 ä¸ª paths
   - é‡æ–°å¤„ç†å‰©ä½™çš„ 350 ä¸ª pathsï¼ˆåŒ…æ‹¬ä¹‹å‰å¤±è´¥çš„ 50 ä¸ªï¼‰
   - **ä»¥è¿½åŠ æ¨¡å¼å†™å…¥**æ–°çš„æˆåŠŸè®°å½•ï¼ˆåŸæœ‰è®°å½•ä¿æŒä¸å˜ï¼‰

3. **å†æ¬¡è¿è¡Œï¼ˆå¦‚æœè¿˜æœ‰å¤±è´¥ï¼‰ï¼š**
   ```bash
   python src/backward_to_query.py --resume --batch-size 10
   ```
   - ç»§ç»­é‡è¯•å¤±è´¥çš„ paths
   - ç›´åˆ°æ‰€æœ‰ paths éƒ½æˆåŠŸæˆ–è¾¾åˆ°é‡è¯•é™åˆ¶

## æ³¨æ„äº‹é¡¹

1. **æ–­ç‚¹ç»­ä¼ **ï¼š
   - ä½¿ç”¨ `--resume` æ—¶ï¼Œä»¥**è¿½åŠ æ¨¡å¼**å†™å…¥ï¼ˆä¸ä¼šè¦†ç›–åŸæ–‡ä»¶ï¼‰
   - æˆåŠŸçš„è®°å½•ä¼šè¢«ä¿ç•™ï¼Œå¤±è´¥çš„è®°å½•ä¸å†™å…¥æ–‡ä»¶
   - **å¤±è´¥çš„ paths ä¼šè‡ªåŠ¨é‡è¯•**ï¼Œæ— éœ€æ‰‹åŠ¨å¹²é¢„
   - å³ä½¿å†™å…¥è¿‡ç¨‹ä¸­å´©æºƒï¼ŒåŸæœ‰çš„æˆåŠŸè®°å½•ä¹Ÿä¸ä¼šä¸¢å¤±
   - å¦‚æœè¾“å‡ºæ–‡ä»¶æŸåï¼Œå»ºè®®åˆ é™¤æ–‡ä»¶é‡æ–°è¿è¡Œ

2. **æ—©åœæœºåˆ¶**ï¼š
   - åªæœ‰è¿ç»­ N ä¸ª batch **å…¨éƒ¨å¤±è´¥**æ‰ä¼šè§¦å‘æ—©åœ
   - å¦‚æœæŸä¸ª batch æœ‰è‡³å°‘ä¸€ä¸ªæˆåŠŸçš„ pathï¼Œè®¡æ•°ä¼šé‡ç½®
   - è®¾ç½® `--early-stop 0` å¯ä»¥ç¦ç”¨æ—©åœ
   - è§¦å‘æ—©åœåï¼Œå¯ä»¥ä½¿ç”¨ `--resume` ç»§ç»­å¤„ç†

3. **å”¯ä¸€æ ‡è¯†**ï¼š
   - æ¯ä¸ª path é€šè¿‡ `(start_index, walk_id)` å…ƒç»„å”¯ä¸€æ ‡è¯†
   - ç¡®ä¿è¾“å…¥æ•°æ®ä¸­çš„ `start_index` å’Œ `walk_id` æ­£ç¡®ä¸”ä¸é‡å¤

4. **å†…å­˜å ç”¨**ï¼š
   - è¾ƒå¤§çš„ batch size å¯ä»¥æé«˜å¹¶å‘åº¦ï¼Œä½†ä¼šå¢åŠ å†…å­˜å ç”¨
   - å¦‚æœé‡åˆ°å†…å­˜ä¸è¶³ï¼Œå¯ä»¥å‡å° `--batch-size`

## æœ€ç»ˆè¾“å‡º

å¤„ç†å®Œæˆåä¼šæ˜¾ç¤ºæ±‡æ€»ä¿¡æ¯ï¼š

```
================================================================================
PROCESSING SUMMARY
================================================================================
Total paths processed: 500
Successful paths: 485
Failed paths: 15
Total tokens used: 1500000
================================================================================

All paths processed, queries saved to: fsp_path/fsp_v1.json
```
