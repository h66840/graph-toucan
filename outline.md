# Graph-Toucan: åŸºäºå›¾ç¿»è¯‘çš„çœŸå® MCP ç¯å¢ƒå¤šè½®å·¥å…·è°ƒç”¨æ•°æ®åˆæˆ

**Graph-Toucan: Synthesizing High-Quality Multi-Turn Tool-Use Data from Real MCP Environments via Graph Translation**

## è®ºæ–‡ç»“æ„å¤§çº²

> **æ ¸å¿ƒå®šä½**: ç»“åˆ TOUCAN çš„çœŸå® MCP ç¯å¢ƒ + MAGNET çš„å›¾æ–¹æ³•ï¼Œç”Ÿæˆé«˜è´¨é‡å¤§è§„æ¨¡å·¥å…·è°ƒç”¨æ•°æ®

---

## 1. Introduction (å¼•è¨€)

### 1.1 ç ”ç©¶èƒŒæ™¯
- **å¤§è¯­è¨€æ¨¡å‹çš„å‘å±•ç°çŠ¶**
  - å¤§è¯­è¨€æ¨¡å‹åœ¨å„é¢†åŸŸçš„åº”ç”¨çªç ´
  - Agentç³»ç»Ÿçš„é‡è¦æ€§ï¼ˆå¦‚Claude Codeã€Kimiã€GLMç­‰ï¼‰
  - Agentè®­ç»ƒä¾èµ–å¤§è§„æ¨¡é«˜è´¨é‡çš„agenticæ•°æ®è¿›è¡Œå¢é‡è®­ç»ƒ

- **Agenticæ•°æ®ä¸Tool Useçš„å…³ç³»**
  - Agenticæ•°æ®çš„æ ¸å¿ƒç»„æˆï¼šå·¥å…·ä½¿ç”¨ï¼ˆTool Useï¼‰èƒ½åŠ›
  - å¼€æºæ¨¡å‹æ¿€å‘agenticæ½œèƒ½çš„å…³é”®ï¼šé«˜è´¨é‡ã€å¤§è§„æ¨¡çš„Tool Useæ•°æ®

### 1.2 Tool Useæ•°æ®çš„å®šä¹‰ä¸åˆ†ç±»
å‚è€ƒBFCL Benchmarkçš„åˆ†ç±»ä½“ç³»ï¼š

- **Single-turnæ•°æ®**
  - **Single-step**: å•è½®å•æ­¥è°ƒç”¨ï¼Œç”¨äºwarm-upæ¨¡å‹çš„åŸºç¡€function callèƒ½åŠ›
  - **Multi-step**: å•è½®å¤šæ­¥è°ƒç”¨ï¼Œå±•ç¤ºæ¨¡å‹å°†large taskæ‹†åˆ†ä¸ºatomic tasksçš„planningèƒ½åŠ›

- **Multi-turnæ•°æ®**
  - æ¨¡æ‹ŸçœŸå®ç”¨æˆ·ä¸æ¨¡å‹çš„back-and-forthäº¤äº’æµç¨‹
  - åŒ…å«ä¸Šä¸‹æ–‡ä¾èµ–ã€ä¿¡æ¯è¡¥å……ã€æ‹’ç»ç­–ç•¥ç­‰å¤æ‚åœºæ™¯

### 1.3 å½“å‰ç ”ç©¶çš„ä¸è¶³ä¸æŒ‘æˆ˜

#### 1.3.1 ç°æœ‰æ•°æ®é›†å¯¹æ¯”

| æ•°æ®é›† | è§„æ¨¡ | å·¥å…·æ¥æº | ç”Ÿæˆæ–¹æ³• | å¤šè½®è´¨é‡ | æ‹’ç»ç­–ç•¥ | ä¸»è¦å±€é™ |
|--------|------|---------|---------|---------|---------|---------|
| **TOUCAN** | 150ä¸‡+ | çœŸå®MCP âœ… | éšæœºé‡‡æ · | ä¸­ç­‰ | ç®€å• | å¤šè½®æ•°æ®è´¨é‡ä½ |
| **MAGNET** | 34K | åˆæˆå‡½æ•° | å›¾æ¸¸èµ° âœ… | é«˜ âœ… | æ—  | éçœŸå®ç¯å¢ƒ |
| **APIGen** | å°è§„æ¨¡ | åˆæˆ | LLMç”Ÿæˆ | ä½ | æ—  | è§„æ¨¡å’Œè´¨é‡éƒ½ä¸è¶³ |
| **ToolACE** | 11K | åˆæˆ | LLMæ¨¡æ‹Ÿ | ä½ | æœ‰ | å·¥å…·å“åº”æ¨¡æ‹Ÿ |

#### 1.3.2 TOUCAN çš„å±€é™æ€§

**ä¼˜åŠ¿**ï¼š
- âœ… ä½¿ç”¨çœŸå® MCP serversï¼ˆ500ä¸ªï¼Œ2000+å·¥å…·ï¼‰
- âœ… çœŸå®å·¥å…·æ‰§è¡Œå’Œå“åº”
- âœ… è§„æ¨¡å¤§ï¼ˆ150ä¸‡+è½¨è¿¹ï¼‰

**ä¸è¶³**ï¼š
- âŒ **éšæœºé‡‡æ ·ç­–ç•¥**ï¼šç¼ºä¹ç»“æ„åŒ–çš„å·¥å…·é€‰æ‹©é€»è¾‘
- âŒ **å¤šè½®æ•°æ®è´¨é‡ä½**ï¼š
  - Avg turns è¾ƒä½
  - ç¼ºå°‘å¤æ‚çš„ä¾èµ–å…³ç³»
  - å·¥å…·è°ƒç”¨é“¾ç®€å•
- âŒ **æ‹’ç»ç­–ç•¥ç®€å•**ï¼šIrrelevance extension ä¸å¤Ÿè¯¦ç»†
- âŒ **ç¼ºå°‘å¯è§£é‡Šæ€§**ï¼šæ— æ³•è§£é‡Šä¸ºä»€ä¹ˆé€‰æ‹©è¿™äº›å·¥å…·ç»„åˆ

#### 1.3.3 MAGNET çš„å±€é™æ€§

**ä¼˜åŠ¿**ï¼š
- âœ… åŸºäºå›¾çš„ç»“æ„åŒ–æ–¹æ³•
- âœ… èŠ‚ç‚¹æ“ä½œï¼ˆInsert/Merge/Splitï¼‰è¦†ç›–å¤šç§åœºæ™¯
- âœ… é«˜è´¨é‡çš„å¤šè½®æ•°æ®
- âœ… å¯è§£é‡Šçš„è½¨è¿¹ç”Ÿæˆè·¯å¾„

**ä¸è¶³**ï¼š
- âŒ **ä½¿ç”¨åˆæˆå‡½æ•°**ï¼šStableToolBench è€ŒéçœŸå® MCP
- âŒ **è§„æ¨¡è¾ƒå°**ï¼š34K SFT æ•°æ®
- âŒ **ç¼ºå°‘çœŸå®æ‰§è¡Œ**ï¼šæ— æ³•éªŒè¯å·¥å…·è°ƒç”¨çš„å®é™…å¯è¡Œæ€§
- âŒ **å·¥å…·å“åº”æ¨¡æ‹Ÿ**ï¼šå¯èƒ½ä¸çœŸå®ç¯å¢ƒæœ‰å·®å¼‚

#### 1.3.4 ç ”ç©¶ç©ºç™½

**æ ¸å¿ƒé—®é¢˜**ï¼šå¦‚ä½•ç»“åˆ TOUCAN çš„çœŸå®æ€§å’Œ MAGNET çš„æ–¹æ³•è®ºï¼Ÿ

- ğŸ” ç¼ºå°‘åœ¨**çœŸå® MCP ç¯å¢ƒ**ä¸‹åº”ç”¨**å›¾æ–¹æ³•**çš„ç ”ç©¶
- ğŸ” ç¼ºå°‘**ç»“æ„åŒ–**ä¸”**å¤§è§„æ¨¡**çš„çœŸå®å·¥å…·è°ƒç”¨æ•°æ®
- ğŸ” ç¼ºå°‘**è¯¦ç»†çš„æ‹’ç»ç­–ç•¥**æ•°æ®ç”Ÿæˆç®—æ³•
- ğŸ” ç¼ºå°‘é’ˆå¯¹**çœŸå® MCP å·¥å…·**çš„æ‰§è¡Œç¯å¢ƒæ¨¡æ‹Ÿæ–¹æ¡ˆ
- ğŸ” **MAGNET æœªå¼€æº**ï¼šæ— æ³•å¤ç°å…¶å›¾æ–¹æ³•ï¼Œæ— æ³•åº”ç”¨äºçœŸå®åœºæ™¯

### 1.4 æœ¬æ–‡çš„ä¸»è¦è´¡çŒ®

æœ¬æ–‡æå‡º **Graph-Toucan**ï¼Œä¸€ä¸ªç»“åˆ TOUCAN çœŸå®æ€§å’Œ MAGNET æ–¹æ³•è®ºçš„å·¥å…·è°ƒç”¨æ•°æ®åˆæˆç³»ç»Ÿã€‚

#### è´¡çŒ® 1: åŸºäº TOUCAN çš„æ”¹è¿› - è¯¦ç»†çš„æ‹’ç»ç­–ç•¥æ•°æ®ç”Ÿæˆ

**é—®é¢˜**ï¼šTOUCAN åœ¨ BFCL miss-info åœºæ™¯ä¸‹è¡¨ç°ä¸ä½³ï¼ŒIrrelevance extension è¿‡äºç®€å•

**æˆ‘ä»¬çš„è§£å†³æ–¹æ¡ˆ**ï¼š
- âœ… è®¾è®¡äº†**è¯¦ç»†çš„ miss-func ç®—æ³•**
  - ä»è½¨è¿¹ä¸­å®šä½å·¥å…·é¦–æ¬¡å‡ºç°ä½ç½®
  - Mask å·¥å…·å¹¶é‡å†™å›ç­”
  - æ•°æ®å˜æ¢ï¼š`[Q, A] â†’ [Q, A1, Q1, A]`
  
- âœ… è®¾è®¡äº†**è¯¦ç»†çš„ miss-params ç®—æ³•**
  - é‡å†™ query ä½¿å…¶ç¼ºå°‘å¿…è¦å‚æ•°
  - ç”Ÿæˆæ‹’ç»å›ç­”å’Œè¡¥å……ä¿¡æ¯
  - æ•°æ®å˜æ¢ï¼š`[Q, A] â†’ [Q1, A1, Q2, A]`

**é¢„æœŸæ•ˆæœ**ï¼šåœ¨ä¿æŒå…¶ä»–æŒ‡æ ‡ä¸ä¸‹é™çš„å‰æä¸‹ï¼Œæ˜¾è‘—æå‡ miss-info æŒ‡æ ‡

#### è´¡çŒ® 2: åŸºäº MAGNET çš„æ”¹è¿› - çœŸå® MCP ç¯å¢ƒä¸‹çš„å›¾æ–¹æ³•

**é—®é¢˜**ï¼š
- TOUCAN ä½¿ç”¨éšæœºé‡‡æ ·ï¼Œå¤šè½®æ•°æ®è´¨é‡ä½
- MAGNET ä½¿ç”¨åˆæˆå‡½æ•°ï¼Œç¼ºä¹çœŸå®æ€§

**æˆ‘ä»¬çš„è§£å†³æ–¹æ¡ˆ**ï¼šå°† MAGNET çš„å›¾æ–¹æ³•åº”ç”¨äº TOUCAN çš„çœŸå® MCP ç¯å¢ƒ

- âœ… **å·¥å…·ä¾èµ–å›¾æ„å»º**ï¼ˆå‚è€ƒ MAGNETï¼‰
  - åŸºäº LLM Judge åˆ¤æ–­ä¾èµ–ç±»å‹ï¼ˆFull/Partial/Prerequisiteï¼‰
  - åº”ç”¨äºçœŸå® MCP å·¥å…·ï¼ˆè€Œéåˆæˆå‡½æ•°ï¼‰
  
- âœ… **å›¾æ¸¸èµ° + æ•°æ®å¢å¼º**ï¼ˆå‚è€ƒ MAGNETï¼‰
  - éšæœºæ¸¸èµ°ç”Ÿæˆ FSP
  - Insert/Merge/Split æ“ä½œè¦†ç›–å¤šç§åœºæ™¯
  
- âœ… **åå‘-å‰å‘ç¿»è¯‘**ï¼ˆå‚è€ƒ MAGNETï¼Œä½†æœ‰æ”¹è¿›ï¼‰
  - è¯¦ç»†çš„ Turn ç±»å‹æ£€æµ‹ï¼ˆ7ç§ç±»å‹ï¼‰
  - é’ˆå¯¹æ¯ç§ç±»å‹çš„ Prompt è®¾è®¡
  - å®Œæ•´çš„ FSP â†’ Query â†’ Execution pipeline

**ä¼˜åŠ¿**ï¼š
- ç›¸æ¯” TOUCANï¼šæ›´é«˜çš„å¯è§£é‡Šæ€§å’Œæ•°æ®è´¨é‡
- ç›¸æ¯” MAGNETï¼šçœŸå® MCP ç¯å¢ƒï¼Œæ›´å¤§è§„æ¨¡

#### è´¡çŒ® 3: ç‹¬ç‰¹çš„æ‰§è¡Œç¯å¢ƒæ¨¡æ‹Ÿæœºåˆ¶

**é—®é¢˜**ï¼šçœŸå® MCP å·¥å…·ç¼ºå°‘ output schemaï¼Œéš¾ä»¥æ¨¡æ‹Ÿæ‰§è¡Œ

**æˆ‘ä»¬çš„è§£å†³æ–¹æ¡ˆ**ï¼š

- âœ… **å·¥å…·åˆ†ç±»**ï¼ˆComputation/Query/Actionï¼‰
  - ä¸ºä¸åŒç±»å‹è®¾è®¡ä¸åŒçš„æ¨¡æ‹Ÿç­–ç•¥
  
- âœ… **Python ä»£ç ç”Ÿæˆ**
  - å°†å·¥å…·è½¬æ¢ä¸ºå¯æ‰§è¡Œçš„ Python ä»£ç 
  - Computation ç±»å‹ï¼šçº¯è®¡ç®—é€»è¾‘
  - Query/Action ç±»å‹ï¼š`call_external_api` + mock æœºåˆ¶
  
- âœ… **Output Schema ç”Ÿæˆ**
  - ä»å®é™…è°ƒç”¨ examples æ¨æ–­ output schema
  - æ”¯æŒå­—æ®µå±•å¹³å’Œé‡æ„

**åˆ›æ–°ç‚¹**ï¼šè¿™æ˜¯é¦–ä¸ªé’ˆå¯¹çœŸå® MCP å·¥å…·çš„ç³»ç»ŸåŒ–æ‰§è¡Œæ¨¡æ‹Ÿæ–¹æ¡ˆ

#### è´¡çŒ® 4: å®Œå…¨å¼€æºçš„æ•°æ®é›†ã€æ¨¡å‹å’Œä»£ç 

> **é‡è¦**ï¼šMAGNET æœªå¼€æºä»£ç ï¼Œæœ¬æ–‡æ˜¯é¦–ä¸ªå¼€æºå®ç°å›¾æ–¹æ³•ç”¨äºå·¥å…·è°ƒç”¨æ•°æ®åˆæˆçš„å·¥ä½œ

- ğŸ“Š **æ•°æ®è§„æ¨¡**ï¼šX ä¸‡è½¨è¿¹ï¼ˆç›®æ ‡ï¼šä¸ TOUCAN ç›¸å½“ï¼‰
- ğŸ¯ **æ•°æ®è´¨é‡**ï¼š
  - æ›´é«˜çš„ avg turnsï¼ˆé€šè¿‡å›¾æ–¹æ³•ï¼‰
  - æ›´å¤æ‚çš„ä¾èµ–å…³ç³»ï¼ˆé€šè¿‡èŠ‚ç‚¹æ“ä½œï¼‰
  - æ›´è¯¦ç»†çš„æ‹’ç»æ ·æœ¬ï¼ˆé€šè¿‡æ”¹è¿›ç®—æ³•ï¼‰
  
- ğŸŒ **å®Œå…¨å¼€æº**ï¼ˆå¡«è¡¥ MAGNET çš„ç©ºç™½ï¼‰ï¼š
  - âœ… **ä»£ç å¼€æº** â†’ GitHub (graph-toucan)
    - å·¥å…·ä¾èµ–å›¾æ„å»ºç®—æ³•å®ç°
    - å›¾æ¸¸èµ°å’Œæ•°æ®å¢å¼ºå®ç°
    - åå‘-å‰å‘ç¿»è¯‘å®Œæ•´ pipeline
    - æ‰§è¡Œç¯å¢ƒæ¨¡æ‹Ÿä»£ç 
  - âœ… **æ•°æ®é›†å¼€æº** â†’ Hugging Face
  - âœ… **æ¨¡å‹å¼€æº** â†’ Hugging Face

**æ„ä¹‰**ï¼š
- ğŸ”¬ **å¯å¤ç°**ï¼šç ”ç©¶è€…å¯ä»¥éªŒè¯å’Œå¤ç°æˆ‘ä»¬çš„ç»“æœ
- ğŸš€ **å¯æ‰©å±•**ï¼šå¯ä»¥åº”ç”¨äºæ–°çš„ MCP servers å’Œå·¥å…·
- ğŸŒ **ç¤¾åŒºè´¡çŒ®**ï¼šæ¨åŠ¨å¼€æºå·¥å…·è°ƒç”¨æ•°æ®åˆæˆç ”ç©¶

#### æ€»ç»“ï¼šæˆ‘ä»¬çš„å®šä½

```
Graph-Toucan = TOUCAN çš„çœŸå®æ€§ + MAGNET çš„æ–¹æ³•è®º + ç‹¬ç‰¹çš„æ‰§è¡Œæ¨¡æ‹Ÿ
```

| ç»´åº¦ | TOUCAN | MAGNET | **Graph-Toucan** |
|------|--------|--------|-----------------|
| æ•°æ®æ¥æº | çœŸå®MCP âœ… | åˆæˆå‡½æ•° | **çœŸå®MCP** âœ… |
| ç”Ÿæˆæ–¹æ³• | éšæœºé‡‡æ · | å›¾æ¸¸èµ° âœ… | **å›¾æ¸¸èµ°** âœ… |
| å¤šè½®è´¨é‡ | ä¸­ç­‰ | é«˜ âœ… | **é«˜** âœ… |
| æ‹’ç»ç­–ç•¥ | ç®€å• | æ—  | **è¯¦ç»†** âœ… |
| æ‰§è¡Œæ¨¡æ‹Ÿ | çœŸå®æ‰§è¡Œ | æ—  | **Pythonæ¨¡æ‹Ÿ** âœ… |
| è§„æ¨¡ | 150ä¸‡+ âœ… | 34K | **Xä¸‡** âœ… |
| **ä»£ç å¼€æº** | âœ… | âŒ | **âœ…** â­ |

---

## 2. Related Work (ç›¸å…³å·¥ä½œ)

### 2.1 Tool Use Benchmarks
- **BFCL (Berkeley Function Calling Leaderboard)**
  - è¯„ä¼°æŒ‡æ ‡ä½“ç³»
  - Miss-infoã€Miss-funcã€Miss-paramsç­‰åœºæ™¯

- **T-Bench**
  - å¤šè½®å¯¹è¯è¯„ä¼°
  - å¤æ‚å·¥å…·è°ƒç”¨åœºæ™¯

### 2.2 å¼€æºTool Useæ•°æ®é›†

#### 2.2.1 TOUCAN (é‡ç‚¹åˆ†æ)

**æ ¸å¿ƒè´¡çŒ®**ï¼š
- å²ä¸Šæœ€å¤§çš„å¼€æºå·¥å…·ä»£ç†æ•°æ®é›†ï¼ˆ150ä¸‡+è½¨è¿¹ï¼‰
- ä½¿ç”¨çœŸå® MCP serversï¼ˆ~500ä¸ªï¼Œ2000+å·¥å…·ï¼‰
- çœŸå®å·¥å…·æ‰§è¡Œå’Œå“åº”

**Pipeline**ï¼š
1. MCP Server Onboardingï¼šç­›é€‰é«˜è´¨é‡ MCP servers
2. Task Synthesisï¼š5ä¸ªæ•™å¸ˆæ¨¡å‹ + Persona å¤šæ ·åŒ–
3. Task Filteringï¼š6ç»´è´¨é‡è¯„ä¼°
4. Trajectory Generationï¼šè¿æ¥çœŸå® MCP æ‰§è¡Œ
5. Trajectory Filteringï¼š3ç»´è½¨è¿¹è¯„ä¼°

**Extensions**ï¼š
- Irrelevanceï¼šç”Ÿæˆæ‹’ç»åœºæ™¯
- Multi-Turnï¼šæ‰©å±•ä¸ºå¤šè½®å¯¹è¯
- Personaï¼šè§’è‰²å¤šæ ·åŒ–

**ä¼˜åŠ¿**ï¼š
- âœ… çœŸå® MCP ç¯å¢ƒ
- âœ… å¤§è§„æ¨¡æ•°æ®
- âœ… å¤šå±‚è´¨é‡è¿‡æ»¤

**å±€é™æ€§**ï¼ˆæœ¬æ–‡æ”¹è¿›ç‚¹ï¼‰ï¼š
- âŒ éšæœºé‡‡æ ·å·¥å…·ï¼Œç¼ºä¹ç»“æ„åŒ–é€»è¾‘
- âŒ å¤šè½®æ•°æ®è´¨é‡ä¸­ç­‰ï¼ˆavg turns ä½ï¼Œä¾èµ–å…³ç³»ç®€å•ï¼‰
- âŒ Irrelevance extension è¿‡äºç®€å•
- âŒ ç¼ºå°‘å¯è§£é‡Šçš„å·¥å…·é€‰æ‹©è·¯å¾„

#### 2.2.2 å…¶ä»–æ•°æ®é›†

- **APIGen**
  - 21ä¸ªåŸŸçš„æ•°æ®
  - LLM ç”Ÿæˆï¼Œè§„æ¨¡è¾ƒå°
  - ç¼ºå°‘çœŸå®å·¥å…·æ‰§è¡Œ

- **ToolACE**
  - 11K è½¨è¿¹
  - å·¥å…·å“åº”ä¸º LLM æ¨¡æ‹Ÿ
  - æœ‰è¾¹ç¼˜æƒ…å†µä½†è§„æ¨¡å°

- **Action98k**
  - 98K åŠ¨ä½œæ•°æ®
  - èšç„¦ç‰¹å®šé¢†åŸŸ

### 2.3 æ•°æ®åˆæˆæ–¹æ³•

#### 2.3.1 MAGNET (é‡ç‚¹åˆ†æ)

**æ ¸å¿ƒè´¡çŒ®**ï¼š
- åŸºäºå›¾çš„å¤šè½®å‡½æ•°è°ƒç”¨æ•°æ®åˆæˆ
- èŠ‚ç‚¹æ“ä½œï¼ˆInsert/Merge/Splitï¼‰
- ä¸Šä¸‹æ–‡è’¸é¦ï¼ˆContext Distillationï¼‰

**æ–¹æ³•**ï¼š
1. **å·¥å…·ä¾èµ–å›¾æ„å»º**
   - å‡½æ•°ä½œä¸ºèŠ‚ç‚¹
   - åŸºäºè¾“å…¥è¾“å‡ºå…³ç³»å»ºç«‹æœ‰å‘è¾¹
   - ä¾èµ–ç±»å‹ï¼šFull/Partial/Prerequisite

2. **å›¾æ¸¸èµ° + FSP ç”Ÿæˆ**
   - éšæœºæ¸¸èµ°é‡‡æ ·å‡½æ•°åºåˆ—
   - å½¢æˆ Function Signature Path (FSP)

3. **èŠ‚ç‚¹æ“ä½œ**
   - Insertï¼šåˆ›å»ºä¾èµ–å…³ç³»ï¼ˆshort/long dependencyï¼‰
   - Mergeï¼šåˆå¹¶è¿ç»­ turn
   - Splitï¼šåˆ›å»ºä¿¡æ¯ç¼ºå¤±åœºæ™¯

4. **å‰åå‘ç¿»è¯‘**
   - Back-translation: FSP â†’ Query
   - Forth-translation: Query â†’ Function Calls

5. **ä¸Šä¸‹æ–‡è’¸é¦**
   - ä½¿ç”¨ Gemini-1.5-pro-002 ä½œä¸ºæ•™å¸ˆ
   - æ­£è´Ÿæ ·æœ¬å¯¹æ¯”å­¦ä¹ 

**å®éªŒç»“æœ**ï¼š
- BFCL-v3 æ’åç¬¬ 4
- å¤šè½®åœºæ™¯æå‡ 32.5 åˆ†
- è¶…è¶Šæ•™å¸ˆæ¨¡å‹

**ä¼˜åŠ¿**ï¼š
- âœ… ç»“æ„åŒ–çš„å›¾æ–¹æ³•
- âœ… é«˜è´¨é‡å¤šè½®æ•°æ®
- âœ… å¯è§£é‡Šçš„ç”Ÿæˆè·¯å¾„
- âœ… è¦†ç›–å¤šç§å¤æ‚åœºæ™¯

**å±€é™æ€§**ï¼ˆæœ¬æ–‡æ”¹è¿›ç‚¹ï¼‰ï¼š
- âŒ ä½¿ç”¨ StableToolBenchï¼ˆåˆæˆå‡½æ•°ï¼‰
- âŒ è§„æ¨¡è¾ƒå°ï¼ˆ34K SFTï¼‰
- âŒ ç¼ºå°‘çœŸå®æ‰§è¡Œ
- âŒ å·¥å…·å“åº”æ¨¡æ‹Ÿ
- âŒ **ä»£ç æœªå¼€æº**ï¼šæ— æ³•å¤ç°å’Œåº”ç”¨äºçœŸå®ç¯å¢ƒæœªé’ˆå¯¹çœŸå® MCP ç¯å¢ƒè®¾è®¡
- âŒ **ä»£ç æœªå¼€æº**ï¼šç ”ç©¶è€…æ— æ³•å¤ç°å’Œæ‰©å±•å…¶æ–¹æ³•

#### 2.3.2 æœ¬æ–‡ä¸ TOUCANã€MAGNET çš„å…³ç³»

**æˆ‘ä»¬çš„å®šä½**ï¼š

```mermaid
graph LR
    A[TOUCAN<br/>çœŸå®MCP<br/>å¤§è§„æ¨¡] --> C[Graph-Toucan<br/>çœŸå®MCP + å›¾æ–¹æ³•<br/>å¤§è§„æ¨¡ + é«˜è´¨é‡]
    B[MAGNET<br/>å›¾æ–¹æ³•<br/>é«˜è´¨é‡] --> C
    C --> D[æœ€ä½³ç»„åˆ]
```

**å¯¹æ¯”è¡¨æ ¼**ï¼š

| ç»´åº¦ | TOUCAN | MAGNET | **Graph-Toucan** |
|------|--------|--------|-----------------|
| **æ•°æ®æ¥æº** | çœŸå®MCP âœ… | åˆæˆå‡½æ•° | **çœŸå®MCP** âœ… |
| **ç”Ÿæˆæ–¹æ³•** | éšæœºé‡‡æ · | å›¾æ¸¸èµ° âœ… | **å›¾æ¸¸èµ°** âœ… |
| **æ•°æ®å¢å¼º** | Extensions | Insert/Merge/Split âœ… | **Insert/Merge/Split** âœ… |
| **æ‹’ç»ç­–ç•¥** | ç®€å• Irrelevance | æ—  | **è¯¦ç»†ç®—æ³•** âœ… |
| **æ‰§è¡Œæ¨¡æ‹Ÿ** | çœŸå®æ‰§è¡Œ | æ—  | **Python æ¨¡æ‹Ÿ** âœ… |
| **è§„æ¨¡** | 150ä¸‡+ âœ… | 34K | **Xä¸‡** âœ… |
| **å¤šè½®è´¨é‡** | ä¸­ç­‰ | é«˜ âœ… | **é«˜** âœ… |
| **ä»£ç å¼€æº** | âœ… | âŒ | **âœ…** â­ |

#### 2.3.3 å…¶ä»–ç›¸å…³å·¥ä½œ

- **Environment Scaling** (T-Bench)
  - ç¯å¢ƒå¤æ‚åº¦é€’å¢
  - è¯„ä¼°å¤šè½®æ¨ç†èƒ½åŠ›

- **LLM-based æ•°æ®åˆæˆ**
  - Self-Instruct
  - Evol-Instruct
  - åº”ç”¨äºå·¥å…·è°ƒç”¨é¢†åŸŸ

---

## 3. Method (æ–¹æ³•)

### 3.1 Graph-Toucan ç³»ç»Ÿæ¦‚è§ˆ

**æ ¸å¿ƒæ€æƒ³**ï¼šç»“åˆ TOUCAN çš„çœŸå® MCP ç¯å¢ƒå’Œ MAGNET çš„å›¾æ–¹æ³•

```mermaid
graph TB
    A[çœŸå® MCP Servers<br/>TOUCAN] --> B[å·¥å…·ä¾èµ–å›¾æ„å»º<br/>MAGNET]
    B --> C[å›¾æ¸¸èµ° + FSP<br/>MAGNET]
    C --> D[æ•°æ®å¢å¼º<br/>MAGNET]
    D --> E[åå‘-å‰å‘ç¿»è¯‘<br/>MAGNET + æ”¹è¿›]
    E --> F[æ‰§è¡Œç¯å¢ƒæ¨¡æ‹Ÿ<br/>æœ¬æ–‡åˆ›æ–°]
    F --> G[æ‹’ç»ç­–ç•¥å¢å¼º<br/>æœ¬æ–‡åˆ›æ–°]
    G --> H[é«˜è´¨é‡æ•°æ®é›†]
```

**ä¸¤å¤§åˆ›æ–°æ–¹å‘**ï¼š
1. **åŸºäº TOUCAN çš„æ”¹è¿›**ï¼ˆSection 3.2ï¼‰
   - å¤ç° TOUCAN çš„åŸºç¡€ pipeline
   - è®¾è®¡è¯¦ç»†çš„æ‹’ç»ç­–ç•¥æ•°æ®ç”Ÿæˆç®—æ³•
   
2. **åŸºäº MAGNET çš„æ”¹è¿›**ï¼ˆSection 3.3ï¼‰
   - å°†å›¾æ–¹æ³•åº”ç”¨äºçœŸå® MCP ç¯å¢ƒ
   - è®¾è®¡æ‰§è¡Œç¯å¢ƒæ¨¡æ‹Ÿæœºåˆ¶

#### 3.1.1 æ•°æ®æ¥æºï¼šçœŸå® MCP Serversï¼ˆå‚è€ƒ TOUCANï¼‰

**MCP Server Onboarding**ï¼ˆå®Œå…¨å‚è€ƒ TOUCANï¼‰ï¼š

1. **çˆ¬å– Smithery å¹³å°**
   - è·å–æ‰€æœ‰å…¬å¼€çš„ MCP servers
   - æå–å·¥å…·è§„èŒƒå’Œå…ƒæ•°æ®

2. **è¿‡æ»¤ç­–ç•¥**
   - å»é™¤éœ€è¦ç¬¬ä¸‰æ–¹è®¤è¯çš„ servers
   - ä¿ç•™æ”¯æŒ remote å’Œ stdio çš„ servers
   - è¿›è¡Œç¨³å®šæ€§æµ‹è¯•

3. **æœ€ç»ˆæ•°æ®**
   - M ä¸ª MCP servers
   - N ä¸ª tools
   - K ä¸ª tagsï¼ˆä» Smithery è·å–ï¼‰

**ä¸ TOUCAN çš„åŒºåˆ«**ï¼š
- âœ… æˆ‘ä»¬ä½¿ç”¨ç›¸åŒçš„ MCP ç­›é€‰æµç¨‹
- âœ… ä½†åç»­ä½¿ç”¨å›¾æ–¹æ³•è€Œééšæœºé‡‡æ ·

### 3.2 åŸºäº TOUCAN çš„æ”¹è¿›ï¼šè¯¦ç»†çš„æ‹’ç»ç­–ç•¥æ•°æ®ç”Ÿæˆ

> **ç›®æ ‡**ï¼šè§£å†³ TOUCAN åœ¨ BFCL miss-info åœºæ™¯ä¸‹è¡¨ç°ä¸ä½³çš„é—®é¢˜

#### 3.2.1 TOUCAN åŸºç¡€ Pipeline å¤ç°

**Step 1: å·¥å…·æ ‡æ³¨ä¸å…³ç³»æ„å»º**ï¼ˆå‚è€ƒ TOUCANï¼‰
- å¯¹Nä¸ªtoolsä½¿ç”¨LLMè¿›è¡Œtagæ ‡æ³¨ï¼ˆæ¯ä¸ªtool 3ä¸ªtagsï¼‰
- æ•°æ®ç»“æ„ï¼š`tools_list: [{toolA: [{function_schema, tags}]}]`

**Step 2: Queryç”Ÿæˆ**
- åŸºäºneighboré€»è¾‘é€‰æ‹©Nä¸ªtoolsï¼ˆ1-3ä¸ªï¼Œè‡³å°‘æœ‰ä¸€ä¸ªtagé‡åˆï¼‰
- å‚è€ƒMä¸ªMCP serverçš„tool list
- ç”Ÿæˆç›®æ ‡ï¼šèƒ½è°ƒç”¨M+Nä¸ªtoolsçš„query
- è¾“å‡ºï¼šAä¸ªQAå¯¹ `[query, target_tool_list]`ï¼ˆsingle-turnæ•°æ®ï¼‰

**Step 3: Trajectory Rollout**
- ä½¿ç”¨LangGraphæ„å»ºrolloutæµç¨‹
- æ‰§è¡ŒAæ¡æ•°æ®ï¼Œå¾—åˆ°Aä¸ªtrajectory
- å€Ÿé‰´Toucanæ–¹æ³•ç”ŸæˆBæ¡multi-turn trajectory

**Step 4: æ•°æ®ç¼ºé™·åˆ†æ**
- åˆ†ææŒ‡æ ‡ï¼šavg turnsã€avg steps per turnã€avg tool calls
- æŒ‡å‡ºç¼ºç‚¹ï¼š**ç¼ºå°‘æ‹’ç»æ ·æœ¬**

#### 3.2.2 æ‹’ç»ç­–ç•¥æ•°æ®å¢å¼ºï¼ˆæœ¬æ–‡åˆ›æ–°ï¼‰

**ä¸ TOUCAN çš„å¯¹æ¯”**ï¼š

| ç»´åº¦ | TOUCAN Irrelevance | **Graph-Toucan æ‹’ç»ç­–ç•¥** |
|------|-------------------|------------------------|
| **Miss-func** | ç®€å•ç”Ÿæˆç¼ºå°‘å‡½æ•°çš„åœºæ™¯ | **è¯¦ç»†ç®—æ³•**ï¼šå®šä½ã€maskã€é‡å†™ |
| **Miss-params** | ç®€å•ç”Ÿæˆç¼ºå°‘å‚æ•°çš„åœºæ™¯ | **è¯¦ç»†ç®—æ³•**ï¼šé‡å†™queryã€æ‹’ç»ã€è¡¥å…… |
| **æ•°æ®å˜æ¢** | æœªæ˜ç¡®è¯´æ˜ | **æ˜ç¡®è§„åˆ™**ï¼š`[Q,A]â†’[Q,A1,Q1,A]` |
| **å¯å¤ç°æ€§** | ä½ | **é«˜**ï¼ˆè¯¦ç»†ç®—æ³•æ­¥éª¤ï¼‰ |

##### Miss-func ç±»å‹æ•°æ®ç”Ÿæˆï¼ˆæœ¬æ–‡åˆ›æ–°ï¼‰
- ç®—æ³•æµç¨‹ï¼š
  1. æ‰¾åˆ°è½¨è¿¹ä¸­æ¯ä¸ªtoolç¬¬ä¸€æ¬¡å‡ºç°çš„ä½ç½®
  2. éšæœºæŠ½æ ·ä¸€ä¸ªtoolåŠå…¶å¯¹åº”çš„turn index
  3. å°†è¯¥toolä»tool schemaä¸­maskæ‰
  4. ä¿®æ”¹è¯¥turnçš„å›ç­”ï¼Œè¾“å‡ºæ‹’ç»åŸå› 
  5. æ’å…¥æ–°çš„QAå¯¹ï¼Œæä¾›ç¼ºå¤±çš„å‡½æ•°schema
- æ•°æ®å˜æ¢ï¼š`[Q, A]` â†’ `[Q, A1, Q1, A]`

**Miss-paramsç±»å‹æ•°æ®ç”Ÿæˆ**
- ç®—æ³•æµç¨‹ï¼š
  1. å¯¹multi-turnæ•°æ®è¿›è¡Œæ ‡æ³¨ï¼ŒæŠ½æ ·éœ€è¦å¢å¼ºçš„æ•°æ®
  2. é‡å†™queryï¼ˆQ1ï¼‰ï¼Œä½¿å…¶ç¼ºå°‘è°ƒç”¨ç›®æ ‡å‡½æ•°çš„å¿…è¦ä¿¡æ¯
  3. é‡å†™answerï¼ˆA1ï¼‰ï¼Œè§£é‡Šä¸ºä»€ä¹ˆä¸èƒ½è°ƒç”¨
  4. æ·»åŠ Q2ï¼Œè¡¥å……ç¼ºå¤±çš„å‚æ•°ä¿¡æ¯
  5. æ­£å¸¸ç»§ç»­è°ƒç”¨
- æ•°æ®å˜æ¢ï¼š`[Q, A]` â†’ `[Q1, A1, Q2, A]`

### 3.3 åŸºäº MAGNET çš„æ”¹è¿›ï¼šçœŸå® MCP ç¯å¢ƒä¸‹çš„å›¾æ–¹æ³•

> **ç›®æ ‡**ï¼šå°† MAGNET çš„å›¾æ–¹æ³•åº”ç”¨äº TOUCAN çš„çœŸå® MCP ç¯å¢ƒï¼Œæå‡å¤šè½®æ•°æ®è´¨é‡

#### 3.3.1 åŠ¨æœºä¸æŒ‘æˆ˜

**TOUCAN çš„é—®é¢˜**ï¼š
- éšæœºé‡‡æ ·å·¥å…·ï¼Œç¼ºä¹ç»“æ„åŒ–é€»è¾‘
- å¤šè½®æ•°æ®è´¨é‡ä¸­ç­‰ï¼ˆavg turns ä½ï¼Œä¾èµ–å…³ç³»ç®€å•ï¼‰
- ç¼ºå°‘å¯è§£é‡Šçš„å·¥å…·é€‰æ‹©è·¯å¾„

**MAGNET çš„ä¼˜åŠ¿**ï¼š
- åŸºäºå›¾çš„ç»“æ„åŒ–æ–¹æ³•
- èŠ‚ç‚¹æ“ä½œè¦†ç›–å¤šç§åœºæ™¯
- é«˜è´¨é‡çš„å¤šè½®æ•°æ®

**æˆ‘ä»¬çš„æŒ‘æˆ˜**ï¼š
- å¦‚ä½•å°† MAGNET çš„å›¾æ–¹æ³•åº”ç”¨äºçœŸå® MCP å·¥å…·ï¼Ÿ
- å¦‚ä½•å¤„ç†çœŸå®å·¥å…·ç¼ºå°‘ output schema çš„é—®é¢˜ï¼Ÿ
- å¦‚ä½•æ¨¡æ‹ŸçœŸå®å·¥å…·çš„æ‰§è¡Œç¯å¢ƒï¼Ÿ

**æˆ‘ä»¬çš„è§£å†³æ–¹æ¡ˆ**ï¼š
1. ä»å®é™…è°ƒç”¨ examples æ¨æ–­ output schema
2. è®¾è®¡å·¥å…·åˆ†ç±»å’Œæ‰§è¡Œæ¨¡æ‹Ÿæœºåˆ¶
3. å®Œæ•´çš„ FSP â†’ Query â†’ Execution pipeline

#### 3.3.2 æ•°æ®é¢„å¤„ç†ï¼ˆæœ¬æ–‡åˆ›æ–° - è§£å†³çœŸå® MCP çš„ç‰¹æ®Šé—®é¢˜ï¼‰

**ä¸ MAGNET çš„åŒºåˆ«**ï¼š
- MAGNET ä½¿ç”¨ StableToolBenchï¼Œå‡½æ•°æœ‰å®Œæ•´çš„ input/output schema
- çœŸå® MCP å·¥å…·é€šå¸¸åªæœ‰ input paramsï¼Œ**ç¼ºå°‘ output schema**
- æˆ‘ä»¬éœ€è¦é¢å¤–çš„é¢„å¤„ç†æ­¥éª¤

**Step 1: Tool Output Schema ç”Ÿæˆ**ï¼ˆæœ¬æ–‡åˆ›æ–°ï¼‰

- **é—®é¢˜**ï¼šMCP ä¸­çš„çœŸå® tools åªæœ‰ input paramsï¼Œç¼ºå°‘ output schema
- è§£å†³æ–¹æ¡ˆï¼š
  - ä»data1ï¼ˆæ–¹æ³•1åˆæˆçš„æ•°æ®ï¼‰ä¸­ä¸ºæ¯ä¸ªtoolé€‰æ‹©3-4ä¸ªå®é™…è°ƒç”¨example
  - ä½¿ç”¨LLMåŸºäºexamplesè®¾è®¡tool output schema
  - å¿½ç•¥ä»input schemaä¼ é€’è€Œæ¥çš„outputå­—æ®µ

**Step 2: Toolåˆ†ç±»**
- ä½¿ç”¨LLMå¯¹toolsè¿›è¡Œåˆ†ç±»ï¼š
  1. **Computation**: ä¸ä¾èµ–å¤–éƒ¨ä¿¡æ¯æºï¼Œä»…æ‰§è¡Œå†…éƒ¨è¿ç®—ï¼ˆå¦‚è®¡ç®—å™¨ã€å•ä½è½¬æ¢ã€JSONè§£æï¼‰
  2. **Query**: ä¾èµ–å¤–éƒ¨ä¿¡æ¯æºæ£€ç´¢æ•°æ®ï¼Œä¸ä¿®æ”¹å¤–éƒ¨çŠ¶æ€ï¼ˆå¦‚æœç´¢æ•°æ®åº“ã€å¤©æ°”æŸ¥è¯¢ã€æ–‡ä»¶è¯»å–ï¼‰
  3. **Action**: ä¾èµ–å¤–éƒ¨ä¿¡æ¯æºï¼Œä¸”ä¼šä¿®æ”¹å¤–éƒ¨çŠ¶æ€ï¼ˆå¦‚åˆ›å»ºæ–‡ä»¶ã€æ‰§è¡Œè„šæœ¬ï¼‰

**Step 3: æœ€ç»ˆToolé›†åˆ**
- å–`tools_output_schema`å’Œ`tool_classification_result`çš„äº¤é›†
- å¾—åˆ°ç”¨äºå»ºå›¾çš„æ‰€æœ‰toolèŠ‚ç‚¹

#### 3.3.3 å·¥å…·ä¾èµ–å›¾æ„å»ºç®—æ³•ï¼ˆå‚è€ƒ MAGNETï¼‰

**è¯´æ˜**ï¼šæ­¤éƒ¨åˆ†å®Œå…¨å‚è€ƒ MAGNET çš„æ–¹æ³•ï¼Œä½†åº”ç”¨äºçœŸå® MCP å·¥å…·

**Step 1: è¾“å‡ºå‚æ•°è¿‡æ»¤**ï¼ˆMAGNET æ–¹æ³•ï¼‰
- è¿‡æ»¤è§„åˆ™ï¼š
  1. è¾“å‡ºå‚æ•°åç§° == è¾“å…¥å‚æ•°åç§° â†’ ç›´æ¥è¿‡æ»¤
  2. è¾“å‡ºå‚æ•°æè¿°ä¸è¾“å…¥å‚æ•°æè¿°è¯­ä¹‰å®Œå…¨ç›¸åŒï¼ˆLLMåˆ¤æ–­ï¼‰â†’ è¿‡æ»¤
- åŸå› ï¼šé¿å…æ— æ„ä¹‰çš„ä¾èµ–å…³ç³»ï¼ˆå¦‚`funcA(userId) â†’ (userId)`, `funcB(userId)`ï¼‰

**Step 2: è¾¹åˆ¤æ–­ï¼ˆåŸºäºLLM Judgeï¼‰**
- åˆ†ææ˜¯å¦åº”è¯¥å»ºç«‹æœ‰å‘è¾¹ `node â†’ candidate`
- ä¾èµ–ç±»å‹åˆ¤æ–­ï¼š

| ä¾èµ–ç±»å‹ | æè¿° | ç¤ºä¾‹ |
|---------|------|------|
| **Full** | nodeè¾“å‡ºå¯ä½œä¸ºcandidateçš„å®Œæ•´è¾“å…¥ | `get_user_info â†’ (id, name)`<br>`send_email(id, name, msg)` |
| **Partial** | nodeè¾“å‡ºå¯ä½œä¸ºcandidateçš„éƒ¨åˆ†è¾“å…¥ | `get_file_path â†’ (path)`<br>`read_file(path, encoding)` |
| **Prerequisite** | nodeè¾“å‡ºå†³å®šæ˜¯å¦åº”è¯¥è°ƒç”¨candidate | `check_file_exists â†’ (exists)`<br>`download_file(url)` |
| **None** | æ— ä¾èµ–å…³ç³» | - |

#### 3.3.4 åŸºäºå›¾æ¸¸èµ°çš„è·¯å¾„ç”Ÿæˆï¼ˆå‚è€ƒ MAGNETï¼‰

**è¯´æ˜**ï¼šæ­¤éƒ¨åˆ†å‚è€ƒ MAGNET çš„å›¾æ¸¸èµ°å’Œæ•°æ®å¢å¼ºæ–¹æ³•

**Step 1: éšæœºæ¸¸èµ°ç”ŸæˆDAG**ï¼ˆMAGNET æ–¹æ³•ï¼‰
- ä»¥æ¯ä¸ªèŠ‚ç‚¹ä¸ºèµ·ç‚¹
- è®¾ç½®`max_steps`ï¼ˆæœ€å¤§æ¸¸èµ°æ¬¡æ•°ï¼‰
- é‡‡æ ·å‡ºæœ‰å‘æ— ç¯å›¾ï¼ˆDAGï¼‰

**Step 2: è·¯å¾„å»é‡**
- å¯¹å•èŠ‚ç‚¹è¿›è¡Œå¤šæ¬¡è·¯å¾„æ¸¸èµ°
- å¯¹è·¯å¾„è¿›è¡Œå»é‡

**Step 3: åˆå§‹FSPç”Ÿæˆ**
- éå†å…¨å›¾ï¼Œå¾—åˆ°åˆå§‹çš„Function Sequence Path (FSP)
- ç»“æ„ï¼šæ¯ä¸ªturnä¸€ä¸ªèŠ‚ç‚¹ï¼ˆå•è½®å¯¹è¯å•å‡½æ•°è°ƒç”¨æ„å›¾ï¼‰

**Step 4: æ•°æ®å¢å¼ºæ“ä½œ**
ç›®æ ‡ï¼šåˆæˆå…·æœ‰ä¾èµ–å…³ç³»ä¸”å¤šå‡½æ•°æ„å›¾çš„æ•°æ®

1. **Mergeæ“ä½œ**ï¼šåˆå¹¶è¿ç»­turn
   - è¾“å…¥ï¼š`turn0: [get_distance]`, `turn1: [set_navigation]`
   - è¾“å‡ºï¼š`turn0: [get_distance, set_navigation]`
   - ç›®çš„ï¼šæ¨¡æ‹Ÿå•è½®å¯¹è¯åŒ…å«å¤šä¸ªå‡½æ•°è°ƒç”¨çš„åœºæ™¯

2. **Insertæ“ä½œ**ï¼šåˆ›å»ºæœ‰ä¾èµ–å…³ç³»çš„å‡½æ•°è°ƒç”¨åœºæ™¯
   - **Short dependency**: åŒä¸€turnä¸­`[funcA, funcB]`å­˜åœ¨æ•°æ®ä¾èµ–
   - **Long dependency**: è·¨turnä¹‹é—´å­˜åœ¨æ•°æ®ä¾èµ–`[funcA]` ... `[funcB]`

3. **Splitæ“ä½œ**ï¼šåˆ›å»ºä¿¡æ¯ç¼ºå¤±åœºæ™¯
   - ç”Ÿæˆ`turn1: []`
   - æ¨¡å‹åº”è¡¨ç¤ºæ‹’ç»è°ƒç”¨çš„æ„å›¾

**æ•´ä½“æµç¨‹å›¾**ï¼š
```mermaid
graph TD
    A[åŠ è½½å·¥å…·ä¾èµ–å›¾] --> B[éšæœºæ¸¸èµ°ç”Ÿæˆè·¯å¾„]
    B --> C[è·¯å¾„å»é‡]
    C --> D[åˆå§‹FSP]
    D --> E[FSPæ•°æ®å¢å¼º]
    E --> E1[Merge: åˆå¹¶è¿ç»­turn]
    E --> E2[Insert: åˆ›å»ºæ•°æ®ä¾èµ–åœºæ™¯]
    E --> E3[Split: åˆ›å»ºä¿¡æ¯ç¼ºå¤±åœºæ™¯]
    E1 --> F[ä¿å­˜JSON]
    E2 --> F
    E3 --> F
```

#### 3.3.5 æ¨¡æ‹Ÿæ•°æ®æ‰§è¡Œç¯å¢ƒï¼ˆæœ¬æ–‡ç‹¬ç‰¹åˆ›æ–°ï¼‰

**åŠ¨æœº**ï¼š
- MAGNET ä½¿ç”¨åˆæˆå‡½æ•°ï¼Œå¯ä»¥ç›´æ¥æ‰§è¡Œ
- çœŸå® MCP å·¥å…·æ— æ³•åœ¨æ•°æ®ç”Ÿæˆé˜¶æ®µå¤§è§„æ¨¡è°ƒç”¨ï¼ˆæˆæœ¬é«˜ã€ä¸ç¨³å®šï¼‰
- éœ€è¦è®¾è®¡æ‰§è¡Œç¯å¢ƒæ¨¡æ‹Ÿæœºåˆ¶

**åˆ›æ–°ç‚¹**ï¼šé¦–ä¸ªé’ˆå¯¹çœŸå® MCP å·¥å…·çš„ç³»ç»ŸåŒ–æ‰§è¡Œæ¨¡æ‹Ÿæ–¹æ¡ˆ

**Step 1: Tool è½¬ Python ä»£ç **ï¼ˆæœ¬æ–‡åˆ›æ–°ï¼‰

- **Computationç±»å‹**ï¼š
  - å®ç°çº¯è®¡ç®—é€»è¾‘
  - ä¸å…è®¸APIè°ƒç”¨å’Œç½‘ç»œè¯·æ±‚

- **Queryå’ŒActionç±»å‹**ï¼š
  - åˆ›å»ºhelperå‡½æ•°ï¼š`call_external_api(tool_name: str) â†’ Dict[str, Any]`
  - è¿”å›æ¥è‡ªå¤–éƒ¨ä¿¡æ¯æºçš„æ•°æ®
  - ä»…è¿”å›flatåçš„simpleå­—æ®µï¼ˆstr, int, bool, floatï¼‰
  - ä¸å…è®¸è¿”å›nestedç»“æ„

**Step 2: å­—æ®µå±•å¹³ï¼ˆFlatteningï¼‰**
- Nested object: `user.name` â†’ `user_name`
- List/Array: `items[].name` â†’ `item_0_name`, `item_1_name`
- å¯¹äºlistå­—æ®µï¼Œç”Ÿæˆ2ä¸ªitems

**Step 3: ä¸»å‡½æ•°å®ç°**
- è°ƒç”¨`call_external_api`è·å–å¤–éƒ¨æ•°æ®
- å°†flatå­—æ®µreconstructä¸ºnested structure
- åŒ…å«é”™è¯¯å¤„ç†å’Œè¾“å…¥å‚æ•°æ ¡éªŒ

#### 3.3.6 åå‘-å‰å‘ç¿»è¯‘ç®—æ³•ï¼ˆå‚è€ƒ MAGNETï¼Œä½†æœ‰æ”¹è¿›ï¼‰

**ä¸ MAGNET çš„å¯¹æ¯”**ï¼š

| ç»´åº¦ | MAGNET | **Graph-Toucan** |
|------|--------|-----------------|
| **Turn ç±»å‹** | æœªæ˜ç¡®åˆ†ç±» | **7ç§è¯¦ç»†ç±»å‹** |
| **Prompt è®¾è®¡** | åŸºç¡€ prompt | **é’ˆå¯¹æ¯ç§ç±»å‹çš„è¯¦ç»† prompt** |
| **æ‰§è¡Œæ¨¡æ‹Ÿ** | æ—  | **Python ä»£ç  + mock API** |

**Step 1: Turn ç±»å‹æ£€æµ‹**ï¼ˆæœ¬æ–‡æ”¹è¿›ï¼‰

| Turnç±»å‹ | æè¿° | Queryç”Ÿæˆç­–ç•¥ |
|---------|------|--------------|
| **Normal** | æ²¡æœ‰è¿›è¡Œä»»ä½•å˜æ¢æ“ä½œ | æ ¹æ®turnçš„å‡½æ•°ç”Ÿæˆæ»¡è¶³è°ƒç”¨å‡½æ•°çš„è¯·æ±‚ |
| **Empty** | è¿›è¡Œäº†splitæ“ä½œ | ç”Ÿæˆæ— æ³•æ»¡è¶³æœ¬è½®å‡½æ•°è°ƒç”¨æ¡ä»¶çš„è¯·æ±‚ |
| **Merge** | è¿›è¡Œäº†mergeæ“ä½œ | ç”Ÿæˆå¤šæ„å›¾è¯·æ±‚ |
| **Insert Short Dependency** | turnå†…insertäº†å‡½æ•° | åªææœ€ç»ˆç›®æ ‡ï¼ˆhelperå‡½æ•°éšå¼ï¼‰ |
| **Insert Long Dependency** | è·¨turnå¼•ç”¨äº†å†å² | ä½¿ç”¨ä»£è¯å¼•ç”¨ï¼ˆå¦‚"that distance"ï¼‰ |
| **Insert Mixed** | åŒæ—¶ç”¨long/short dependency | æ··åˆç­–ç•¥ |
| **Merge with Insert** | æ··åˆ | å¤šæ„å›¾å¹¶è¡Œ + ä»£è¯å¼•ç”¨ |

**Step 2: ä¸ºæ¯ç§Turnç±»å‹æ„å»ºPrompt**

ç¤ºä¾‹Promptç»“æ„ï¼š

- **Empty Turn Prompt**:
```
You are role-playing as a user in a multi-turn conversation with a function-calling agent. This is Turn {turn_idx}.

The user will make a request, but there is NO suitable function available to fulfill it, or the request is missing critical parameters.

{error_feedback_prompt}
{history_block}
{last_round_block}

Your task:
Generate a natural user query that would require a function that doesn't exist, or that is missing critical information.
```

- **Merged Turn Prompt**:
```
This is a MERGED scenario where you express multiple intents in a single query.

MERGED Definition:
- Multiple functions in the SAME turn with potential SHORT DEPENDENCY
- Output of one function may feed as input to the next (within same turn)
- User EXPLICITLY mentions ALL actions/intents

Use connecting words to link multiple intents: "and", "then"...

** All functions to call**: {turn_functions}

{error_feedback_prompt}
{history_block}
{last_round_block}

CRITICAL Instructions:
1. Explicitly mention all {len(turn_functions)} intents/actions in your query
2. Use connecting words: and, then, after that
3. Make the data flow clear if function has dependency
4. Each function should be reflected in the query
5. Natural combination of multiple explicit intents

Contrast with insert short:
- Insert short: "Navigate to San Mateo" (only final goal, distance is implicit)
- Merged: "Find the distance to San Mateo and set up navigation" (both are explicit)

{style_instruction}
{examples_block}

Candidate Functions:
{candidate_block}
```

- **Merge with Insert Prompt**:
```
This is a Merge + Insert scenario with multiple types of functions.

Function Classification:
- MERGED functions (explicit intents): {merged_funcs_str}
- LONG-DEPENDENCY functions (explicit, reference history): {long_dep_funcs_str}
- SHORT-DEPENDENCY helpers (implicit, do NOT mention)

**ALL functions to call**

Dependency Info:
Short dependency:
  {source_func} â†’ {target_func}
  {source_func} output: ...
  {target_func} input schema: see params in Candidate functions below

Long dependency:
  Turn {source_turn}: {source_func} â†’ Turn {target_turn}: {target_func}
  {source_func} output: ...
  {target_func} input: ...

{history_block}
{last_round_block}

CRITICAL INSTRUCTIONS:
- MERGED functions: Express these explicit intents clearly
- Long-dependency functions:
  * Express these intents BUT use pronouns to reference previous outputs
  * DO NOT repeat specific values from history
  * Understand the cross-turn data flow
```

**Step 3: Queryç”Ÿæˆ**
- è°ƒç”¨LLMï¼ŒåŸºäºæ„å»ºçš„promptç”Ÿæˆquery

**Step 4: å‰å‘æ‰§è¡Œï¼ˆForward Executionï¼‰**

å•ä¸ªTurnçš„æ‰§è¡Œæµç¨‹ï¼š
```python
for func in execution_order:
    # 1. ç”Ÿæˆå‚æ•°
    param_result = generate_single_func_params(
        turn_query, function_name, context, tool_schemas
    )
    # LLMè¾“å‡ºæ¯ä¸ªå‚æ•°å€¼çš„æ¥æºï¼šcontext or query
    # å¦‚æœä¸èƒ½æ‰¾åˆ°ï¼Œæ‹’ç»å¡«å‚æ•°
    
    # 2. æ‰§è¡Œå‡½æ•°
    exec_result = execute_function_call(
        function_name, param_result, tool_schema
    )
    # æ‰§è¡Œé€»è¾‘ï¼š
    # - åˆ¤æ–­æ˜¯å¦ä¾èµ–å¤–éƒ¨ä¿¡æ¯ï¼ˆæ˜¯å¦æœ‰call_external_apiï¼‰
    # - å¦‚æœæœ‰ï¼Œå…ˆæ‰§è¡Œsimulate_call_external_api
    # - åŠ¨æ€æ›¿æ¢placeholderä¸ºmock_api
    # - è¿è¡Œå‡½æ•°åå†æ›¿æ¢å›æ¥
    
    turn_output.append(exec_result)
```

å¤šä¸ªTurnçš„æ‰§è¡Œæµç¨‹ï¼š
```python
for single_turn in turns:
    detect_turn_type()
    construct_turn_prompt_for_each_turn()
    generate_each_turn_query()
    forward_to_turn_params()  # åŒ…å«single turnçš„å¾ªç¯
```

### 3.4 æ•°æ®è´¨é‡åˆ†æä¸å¯¹æ¯”

#### 3.4.1 æ•°æ®é›†ç»Ÿè®¡

å¯¹ç”Ÿæˆçš„ Graph-Toucan æ•°æ®é›†è¿›è¡Œå…¨é¢ç»Ÿè®¡åˆ†æï¼š

**è§„æ¨¡æŒ‡æ ‡**ï¼š
- Total trajectories
- Single-turn vs Multi-turn æ¯”ä¾‹
- æ‹’ç»ç­–ç•¥æ•°æ®æ¯”ä¾‹

**è´¨é‡æŒ‡æ ‡**ï¼š
- Avg turns per conversation
- Avg steps per turn
- Avg tool calls per turn
- ä¾èµ–å…³ç³»åˆ†å¸ƒï¼ˆFull/Partial/Prerequisiteï¼‰
- Turn ç±»å‹åˆ†å¸ƒï¼ˆNormal/Empty/Merge/Insert/...ï¼‰

#### 3.4.2 ä¸ TOUCAN å’Œ MAGNET çš„å¯¹æ¯”

**å¯¹æ¯”è¡¨æ ¼**ï¼š

| æŒ‡æ ‡ | TOUCAN | MAGNET | **Graph-Toucan** | æ”¹è¿› |
|------|--------|--------|-----------------|------|
| **Avg turns** | X | Y | **Z** | â†‘ |
| **Avg steps/turn** | A | B | **C** | â†‘ |
| **Avg tool calls** | D | E | **F** | â†‘ |
| **ä¾èµ–å…³ç³»å¤æ‚åº¦** | ä½ | é«˜ | **é«˜** | âœ… |
| **æ‹’ç»æ ·æœ¬æ¯”ä¾‹** | ä½ | 0% | **é«˜** | âœ… |
| **å·¥å…·æ¥æº** | çœŸå®MCP | åˆæˆ | **çœŸå®MCP** | âœ… |

**åˆ†æé‡ç‚¹**ï¼š
1. ç›¸æ¯” TOUCANï¼šæ›´é«˜çš„å¤šè½®è´¨é‡æŒ‡æ ‡
2. ç›¸æ¯” MAGNETï¼šä¿æŒé«˜è´¨é‡çš„åŒæ—¶ä½¿ç”¨çœŸå® MCP
3. ç‹¬ç‰¹ä¼˜åŠ¿ï¼šè¯¦ç»†çš„æ‹’ç»ç­–ç•¥æ•°æ®

---

## 4. Experiments (å®éªŒ)

### 4.1 å®éªŒè®¾ç½®

#### 4.1.1 æ•°æ®é›†ç»Ÿè®¡
- **æ•°æ®è§„æ¨¡**
  - Single-turnæ•°æ®é‡ï¼ˆsingle-step vs multi-stepï¼‰
  - Multi-turnæ•°æ®é‡
  - æ‹’ç»ç­–ç•¥æ•°æ®é‡ï¼ˆmiss-func vs miss-paramsï¼‰
  - å›¾åˆæˆæ•°æ®é‡

- **æ•°æ®è´¨é‡æŒ‡æ ‡**
  - Avg tool calls per turn
  - Avg steps per turn
  - Avg turns per conversation
  - ä¾èµ–å…³ç³»åˆ†å¸ƒï¼ˆfull/partial/prerequisiteï¼‰

#### 4.1.2 è®­ç»ƒæ¡†æ¶
- ä½¿ç”¨çš„è®­ç»ƒæ¡†æ¶ï¼ˆå¦‚TRLï¼‰
- æ¨¡å‹é€‰æ‹©
- è®­ç»ƒè¶…å‚æ•°

#### 4.1.3 å¯¹æ¯”åŸºçº¿

**ä¸»è¦å¯¹æ¯”**ï¼š
1. **TOUCAN**
   - ä½¿ç”¨å…¶å…¬å¼€çš„æ•°æ®é›†å’Œæ¨¡å‹
   - é‡ç‚¹å¯¹æ¯”ï¼šå¤šè½®æ•°æ®è´¨é‡ã€miss-info æ€§èƒ½

2. **MAGNET**
   - å¤ç°å…¶æ–¹æ³•ï¼ˆä½¿ç”¨åˆæˆå‡½æ•°ï¼‰
   - é‡ç‚¹å¯¹æ¯”ï¼šå›¾æ–¹æ³•çš„æœ‰æ•ˆæ€§

3. **Graph-Toucan (Ours)**
   - ç»“åˆä¸¤è€…ä¼˜åŠ¿
   - çœŸå® MCP + å›¾æ–¹æ³•

**å…¶ä»–åŸºçº¿**ï¼š
- APIGen
- ToolACE
- Action98k

**æ¶ˆèå®éªŒç»„**ï¼š

| å®éªŒç»„ | æ•°æ®æ¥æº | ç”Ÿæˆæ–¹æ³• | æ‹’ç»ç­–ç•¥ | è¯´æ˜ |
|--------|---------|---------|---------|------|
| **Baseline 1** | çœŸå®MCP | éšæœºé‡‡æ · | ç®€å• | å¤ç° TOUCAN |
| **Baseline 2** | åˆæˆå‡½æ•° | å›¾æ¸¸èµ° | æ—  | å¤ç° MAGNET |
| **Ablation 1** | çœŸå®MCP | å›¾æ¸¸èµ° | æ—  | éªŒè¯å›¾æ–¹æ³•åœ¨çœŸå®MCPçš„æ•ˆæœ |
| **Ablation 2** | çœŸå®MCP | éšæœºé‡‡æ · | è¯¦ç»† | éªŒè¯æ‹’ç»ç­–ç•¥çš„æ•ˆæœ |
| **Graph-Toucan** | çœŸå®MCP | å›¾æ¸¸èµ° | è¯¦ç»† | å®Œæ•´æ–¹æ³• |

### 4.2 è¯„ä¼°Benchmarks

#### 4.2.1 BFCL (Berkeley Function Calling Leaderboard)
- **æ•´ä½“æ€§èƒ½**
  - å„ç±»åœºæ™¯çš„å‡†ç¡®ç‡å¯¹æ¯”

- **Miss-infoåœºæ™¯é‡ç‚¹åˆ†æ**
  - Miss-funcæ€§èƒ½æå‡
  - Miss-paramsæ€§èƒ½æå‡
  - ä¸Toucançš„å¯¹æ¯”

- **å…¶ä»–æŒ‡æ ‡ä¿æŒæƒ…å†µ**
  - Simpleåœºæ™¯
  - Multipleåœºæ™¯
  - Parallelåœºæ™¯

#### 4.2.2 Ï„-Bench
- å¤šè½®å¯¹è¯æ€§èƒ½è¯„ä¼°
- å¤æ‚å·¥å…·è°ƒç”¨åœºæ™¯è¡¨ç°
- åŠ¨æ€ç”¨æˆ·äº¤äº’

#### 4.2.3 Ï„Â²-Bench
- æ›´å¤æ‚çš„å¤šè½®åœºæ™¯
- å·¥å…·é“¾æ‰§è¡Œèƒ½åŠ›

#### 4.2.4 MCP-Universe Benchmark
- **æœ€æ–°åŸºå‡†**ï¼ˆ231ä¸ªçœŸå®ä»»åŠ¡ï¼Œ11ä¸ªçœŸå®MCP serversï¼‰
- æ‰§è¡ŒåŸºç¡€çš„è¯„ä¼°
- çœŸå®ä¸–ç•Œåº”ç”¨åœºæ™¯
- **é‡ç‚¹**ï¼šéªŒè¯åœ¨çœŸå® MCP ç¯å¢ƒä¸‹çš„æ€§èƒ½

#### 4.2.5 å…¶ä»– Benchmark
- ToolQuery
- StableToolBenchï¼ˆå¦‚æœé€‚ç”¨ï¼‰

### 4.3 æ¶ˆèå®éªŒ (Ablation Study)

#### 4.3.1 æ‹’ç»ç­–ç•¥æ•°æ®çš„å½±å“
- ä¸åŠ æ‹’ç»ç­–ç•¥æ•°æ® vs åŠ æ‹’ç»ç­–ç•¥æ•°æ®
- Miss-funcæ•°æ®çš„å•ç‹¬å½±å“
- Miss-paramsæ•°æ®çš„å•ç‹¬å½±å“

#### 4.3.2 å›¾åˆæˆæ•°æ®çš„å½±å“
- ä»…ä½¿ç”¨Toucanæ•°æ® vs åŠ å…¥å›¾åˆæˆæ•°æ®
- ä¸åŒæ•°æ®å¢å¼ºæ“ä½œçš„å½±å“ï¼ˆmerge/insert/splitï¼‰

#### 4.3.3 å·¥å…·ä¾èµ–å›¾æ„å»ºæ–¹æ³•çš„å½±å“
- ä¸åŒè¾¹åˆ¤æ–­ç­–ç•¥çš„å½±å“
- è¾“å‡ºå‚æ•°è¿‡æ»¤çš„å½±å“

### 4.4 æ•°æ®è´¨é‡åˆ†æ

#### 4.4.1 äººå·¥è¯„ä¼°
- éšæœºæŠ½æ ·æ•°æ®è¿›è¡Œäººå·¥è¯„ä¼°
- è¯„ä¼°ç»´åº¦ï¼š
  - Queryè‡ªç„¶åº¦
  - å‡½æ•°è°ƒç”¨åˆç†æ€§
  - ä¾èµ–å…³ç³»æ­£ç¡®æ€§
  - æ‹’ç»ç­–ç•¥åˆç†æ€§

#### 4.4.2 è‡ªåŠ¨åŒ–æŒ‡æ ‡
- æ•°æ®å¤šæ ·æ€§åˆ†æ
- å¤æ‚åº¦åˆ†å¸ƒ
- ä¾èµ–å…³ç³»è¦†ç›–ç‡

### 4.5 å®éªŒç»“æœä¸åˆ†æ

#### 4.5.1 ä¸»è¦ç»“æœ
- åœ¨BFCLä¸Šçš„æ€§èƒ½æå‡
- åœ¨T-Benchä¸Šçš„æ€§èƒ½æå‡
- ä¸åŸºçº¿æ¨¡å‹çš„å¯¹æ¯”

#### 4.5.2 æ¡ˆä¾‹åˆ†æ
- æˆåŠŸæ¡ˆä¾‹å±•ç¤º
- å¤±è´¥æ¡ˆä¾‹åˆ†æ
- æ”¹è¿›æ–¹å‘

---

## 5. Conclusion and Future Work (ç»“è®ºä¸æœªæ¥å·¥ä½œ)

### 5.1 å·¥ä½œæ€»ç»“
- æœ¬æ–‡çš„ä¸»è¦è´¡çŒ®å›é¡¾
- å®éªŒç»“æœæ€»ç»“
- æ–¹æ³•çš„ä¼˜åŠ¿ä¸å±€é™æ€§

### 5.2 æœªæ¥å·¥ä½œæ–¹å‘

#### 5.2.1 æ•°æ®é›†æ‰©å±•
- å¢åŠ æ›´å¤šMCP servers
- æ”¯æŒæ›´å¤šè¯­è¨€çš„queryç”Ÿæˆ
- å¢åŠ æ›´å¤æ‚çš„ä¾èµ–å…³ç³»ç±»å‹

#### 5.2.2 æ–¹æ³•æ”¹è¿›
- æ›´ç²¾ç»†çš„å·¥å…·ä¾èµ–å›¾æ„å»º
- æ›´æ™ºèƒ½çš„æ•°æ®å¢å¼ºç­–ç•¥
- æ›´çœŸå®çš„æ‰§è¡Œç¯å¢ƒæ¨¡æ‹Ÿ

#### 5.2.3 åº”ç”¨æ‹“å±•
- æ”¯æŒæ›´å¤šä¸‹æ¸¸ä»»åŠ¡
- ä¸å…¶ä»–agentèƒ½åŠ›çš„ç»“åˆï¼ˆå¦‚æ¨ç†ã€è§„åˆ’ï¼‰
- å®é™…åº”ç”¨åœºæ™¯çš„éªŒè¯

---

## é™„å½• (Appendix)

### A. Prompt Templates
- å·¥å…·ä¾èµ–å›¾æ„å»ºçš„è¯¦ç»†prompt
- Queryç”Ÿæˆçš„è¯¦ç»†promptï¼ˆå„ç§turnç±»å‹ï¼‰
- å‚æ•°ç”Ÿæˆçš„è¯¦ç»†prompt
- æ‰§è¡Œæ¨¡æ‹Ÿçš„è¯¦ç»†prompt

### B. æ•°æ®é›†è¯¦ç»†ç»Ÿè®¡
- MCP serversåˆ—è¡¨ä¸ç»Ÿè®¡
- Toolåˆ†ç±»è¯¦ç»†ç»“æœ
- å·¥å…·ä¾èµ–å›¾å¯è§†åŒ–

### C. å®éªŒè¯¦ç»†ç»“æœ
- å®Œæ•´çš„benchmarkç»“æœè¡¨æ ¼
- æ¶ˆèå®éªŒè¯¦ç»†æ•°æ®
- äººå·¥è¯„ä¼°è¯¦ç»†ç»“æœ

### D. æ¡ˆä¾‹å±•ç¤º
- å„ç§turnç±»å‹çš„ç”Ÿæˆæ ·ä¾‹
- æ‹’ç»ç­–ç•¥æ•°æ®æ ·ä¾‹
- å¤æ‚ä¾èµ–å…³ç³»æ ·ä¾‹

---

## å‚è€ƒæ–‡çŒ® (References)

### æ ¸å¿ƒå‚è€ƒæ–‡çŒ®
1. Toucanè®ºæ–‡åŠGitHub repo
2. Magnetè®ºæ–‡
3. BFCL benchmarkè®ºæ–‡åŠblog
4. T-Benchè®ºæ–‡
5. APIGenè®ºæ–‡
6. ToolACEè®ºæ–‡
7. Action98kè®ºæ–‡
8. KimiæŠ€æœ¯æŠ¥å‘Š
9. GLMæŠ€æœ¯æŠ¥å‘Š
10. ClaudeæŠ€æœ¯æŠ¥å‘Š

### ç›¸å…³å·¥ä½œ
- MCP (Model Context Protocol)ç›¸å…³æ–‡çŒ®
- LLM-basedæ•°æ®åˆæˆæ–¹æ³•
- Agentè®­ç»ƒæ–¹æ³•
- Function callingç›¸å…³ç ”ç©¶
